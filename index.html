doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thời Khóa Biểutitle>
  <meta name="theme-color" content="#5a67d8">
  <script src="https://cdn.tailwindcss.com">script>
  <script src="/_sdk/element_sdk.js">script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    
    :root {
      --bg-main: #fafbfc;
      --bg-secondary: #ffffff;
      --text-primary: #1a202c;
      --text-secondary: #718096;
      --border-color: #e5e7eb;
      --accent-color: #5a67d8;
      --accent-hover: #4c51bf;
      --lesson-bg: #f7fafc;
    }
    
    [data-theme="dark"] {
      --bg-main: #0f1419;
      --bg-secondary: #1a202c;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --border-color: #374151;
      --accent-color: #667eea;
      --accent-hover: #5a67d8;
      --lesson-bg: #2d3748;
    }
    
    body {
      background: var(--bg-main);
      color: var(--text-primary);
      transition: background 0.2s, color 0.2s;
    }
    
    .card-bg {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
    }
    
    .text-primary {
      color: var(--text-primary);
    }
    
    .text-secondary {
      color: var(--text-secondary);
    }
    
    .border-custom {
      border-color: var(--border-color);
    }
    
    .schedule-grid {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 0;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .schedule-cell {
      background: var(--bg-secondary);
      padding: 12px;
      min-height: 80px;
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
    }
    
    .schedule-cell:nth-child(6n) {
      border-right: none;
    }
    
    .schedule-header {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      padding: 16px 12px;
      text-align: center;
      font-size: 0.875rem;
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      letter-spacing: -0.01em;
    }
    
    .schedule-header:last-child {
      border-right: none;
    }
    
    .schedule-time {
      background: var(--bg-main);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-secondary);
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      letter-spacing: -0.01em;
    }
    
    .session-header {
      background: var(--bg-main);
      color: var(--text-primary);
      font-weight: 600;
      padding: 10px;
      text-align: center;
      font-size: 0.813rem;
      grid-column: 1 / -1;
      border-bottom: 1px solid var(--border-color);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    
    .lesson-card {
      background: var(--lesson-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px;
      font-size: 0.813rem;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.15s ease;
    }
    
    .lesson-card:hover {
      border-color: var(--accent-color);
      box-shadow: 0 2px 8px rgba(90, 103, 216, 0.1);
    }
    
    .lesson-subject {
      font-weight: 600;
      font-size: 0.875rem;
      line-height: 1.4;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }
    
    .lesson-info {
      font-size: 0.75rem;
      line-height: 1.5;
      color: var(--text-secondary);
      letter-spacing: -0.005em;
    }
    
    @media print {
      body {
        background: white !important;
        color: black !important;
      }
      
      .no-print {
        display: none !important;
      }
      
      .print-page {
        page-break-after: always;
        page-break-inside: avoid;
      }
      
      .print-page:last-child {
        page-break-after: auto;
      }
      
      .schedule-grid {
        border: 1px solid #d1d5db;
      }
      
      .schedule-cell, .schedule-header, .schedule-time {
        background: white !important;
        border-color: #d1d5db !important;
      }
      
      .lesson-card {
        background: #f9fafb !important;
        border-color: #d1d5db !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      @page {
        size: A4 landscape;
        margin: 1cm;
      }
    }
    
    .loading-spinner {
      border: 2px solid var(--border-color);
      border-top: 2px solid var(--accent-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .btn-primary {
      background: var(--accent-color);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.15s;
      border: none;
      cursor: pointer;
      letter-spacing: -0.01em;
    }
    
    .btn-primary:hover {
      background: var(--accent-hover);
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.15s;
      border: 1px solid var(--border-color);
      cursor: pointer;
    }
    
    .btn-secondary:hover {
      border-color: var(--accent-color);
      background: var(--bg-main);
    }
    
    select, input {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: all 0.15s;
      font-family: inherit;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.08);
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--accent-color);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .code-container {
      position: relative;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }
    
    .code-content {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      line-height: 1.6;
      color: var(--text-secondary);
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.15s;
    }
    
    .copy-btn:hover {
      background: var(--accent-hover);
    }
    
    .copy-btn.copied {
      background: #10b981;
    }
  style>
  <style>@view-transition { navigation: auto; }style>
  <script src="/_sdk/data_sdk.js" type="text/javascript">script>
 head>
 <body class="h-full">
  <div id="app-wrapper" class="min-h-full w-full overflow-auto">-- Loading State -->
   <div id="loading-state" class="flex flex-col items-center justify-center min-h-full p-8">
    <div class="loading-spinner mb-4">div>
    <p class="text-primary font-medium text-sm">Đang tải dữ liệu...p>
   div>-- Main Content -->
   <div id="main-content" class="hidden">-- Navigation -->
    <nav class="no-print card-bg border-b border-custom">
     <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-14">
       <div class="flex items-center gap-3">
        <svg class="w-6 h-6" style="color: var(--accent-color)" fill="currentColor" viewbox="0 0 20 20"><path d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z">path>
        svg>
        <div>
         <h1 id="school-name" class="text-base font-semibold text-primary" style="letter-spacing: -0.02em;">Thời Khóa Biểuh1>
         <p id="school-year" class="text-xs text-secondary">2024-2025p>
        div>
       div>
       <div class="flex items-center gap-2"><button onclick="toggleDarkMode()" class="btn-secondary p-2" aria-label="Chuyển chế độ sáng tối">
         <svg id="icon-light" class="w-4 h-4 hidden" fill="currentColor" viewbox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z">path>
         svg>
         <svg id="icon-dark" class="w-4 h-4" fill="currentColor" viewbox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z">path>
         svg>button> <button onclick="refreshData()" class="btn-secondary p-2" aria-label="Làm mới dữ liệu">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">path>
         svg>button>
       div>
      div>
     div>
    nav>-- Controls -->
    <div class="no-print max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
     <div class="card-bg rounded-lg p-5 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
       <div><label for="view-type" class="block text-xs font-medium mb-2 text-primary">Xem theolabel> <select id="view-type" onchange="changeViewType()" class="w-full"> <option value="all">Tất cảoption> <option value="class">Theo lớpoption> <option value="teacher">Theo giáo viênoption> select>
       div>
       <div id="filter-container"><label for="filter-select" class="block text-xs font-medium mb-2 text-primary">Chọnlabel> <select id="filter-select" onchange="applyFilter()" class="w-full"> <option value="">-- Chọn --option> select>
       div>
       <div class="flex items-end"><button onclick="printSchedule()" class="btn-primary w-full flex items-center justify-center gap-2">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">path>
         svg> In / Xuất PDF button>
       div>
       <div class="flex items-end"><button onclick="showCodeDialog()" class="btn-secondary w-full flex items-center justify-center gap-2">
         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4">path>
         svg> Xem mã button>
       div>
      div>
     div>
    div>-- Schedule Container -->
    <div id="schedule-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
    div>
   div>-- Error State -->
   <div id="error-state" class="hidden flex flex-col items-center justify-center min-h-full p-8 text-center">
    <svg class="w-16 h-16 text-secondary mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">path>
    svg>
    <h2 class="text-xl font-semibold mb-2 text-primary">Không thể tải dữ liệuh2>
    <p id="error-message" class="text-secondary text-sm mb-6">Đã xảy ra lỗi khi tải dữ liệu từ Google Sheetsp><button onclick="refreshData()" class="btn-primary">Thử lạibutton>
   div>-- Code Dialog Overlay -->
   <div id="code-dialog" class="no-print hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="hideCodeDialog(event)">
    <div class="card-bg rounded-lg max-w-4xl w-full max-h-[80%] overflow-hidden" onclick="event.stopPropagation()">
     <div class="p-5 border-b border-custom flex items-center justify-between">
      <h3 class="text-lg font-semibold text-primary">Link Google Sheetsh3><button onclick="hideCodeDialog()" class="text-secondary hover:text-primary">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">path>
       svg>button>
     div>
     <div class="p-5 overflow-auto" style="max-height: calc(80vh - 140px);">
      <p class="text-sm text-secondary mb-3">Sao chép link dưới đây để kết nối với Google Sheets của bạn:p>
      <div class="code-container"><button class="copy-btn" onclick="copyCode()"> <span id="copy-text">Copyspan> button>
       <div class="code-content" id="code-content">
        https://docs.google.com/spreadsheets/d/e/2PACX-1vQwOEHVTQIC1AXGYCilV9Zo6LZLaliGTl8a4IL5CI662fRcPaIxp02ao9KO06XVXmdnTsaz_i3opSyS/pub?output=csv
       div>
      div>
      <div class="mt-4 p-4 rounded-lg" style="background: var(--bg-main); border: 1px solid var(--border-color);">
       <p class="text-xs text-secondary leading-relaxed"><strong class="text-primary">Hướng dẫn:strong><br>
         1. Mở Google Sheets của bạn<br>
         2. Chọn File → Share → Publish to web<br>
         3. Chọn "Comma-separated values (.csv)"<br>
         4. Copy link và thay thế vào mã nguồnp>
      div>
     div>
    div>
   div>
  div>
  <script>
    const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQwOEHVTQIC1AXGYCilV9Zo6LZLaliGTl8a4IL5CI662fRcPaIxp02ao9KO06XVXmdnTsaz_i3opSyS/pub?output=csv';
    
    const DAYS = ['', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6'];
    const PERIODS_MORNING = [
      { label: 'Tiết 1', value: 1, session: 'morning' },
      { label: 'Tiết 2', value: 2, session: 'morning' },
      { label: 'Tiết 3', value: 3, session: 'morning' },
      { label: 'Tiết 4', value: 4, session: 'morning' },
      { label: 'Tiết 5', value: 5, session: 'morning' }
    ];
    const PERIODS_AFTERNOON = [
      { label: 'Tiết 1', value: 1, session: 'afternoon' },
      { label: 'Tiết 2', value: 2, session: 'afternoon' },
      { label: 'Tiết 3', value: 3, session: 'afternoon' },
      { label: 'Tiết 4', value: 4, session: 'afternoon' },
      { label: 'Tiết 5', value: 5, session: 'afternoon' }
    ];
    
    let allData = [];
    let scheduleData = [];
    let classes = new Set();
    let teachers = new Set();
    let currentView = 'all';
    let currentFilter = '';
    let config = {};
    
    const defaultConfig = {
      school_name: 'Thời Khóa Biểu',
      school_year: '2024-2025'
    };
    
    // Parse CSV
    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      const result = [];
      
      for (const line of lines) {
        if (line.trim()) {
          const row = [];
          let current = '';
          let inQuotes = false;
          
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              row.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          row.push(current.trim());
          result.push(row);
        }
      }
      
      return result;
    }
    
    // Transform data to schedule format
    function transformData(data) {
      if (!data || data.length === 0) return [];
      
      const headers = data[0].map(h => h.toLowerCase().trim());
      const rows = data.slice(1);
      
      const dayIdx = headers.indexOf('day');
      const hourIdx = headers.indexOf('hour');
      const classIdx = headers.indexOf('students sets');
      const subjectIdx = headers.indexOf('subject');
      const teacherIdx = headers.indexOf('teachers');
      const roomIdx = headers.indexOf('room');
      
      const schedule = [];
      classes.clear();
      teachers.clear();
      
      rows.forEach(row => {
        if (row.length > 0 && row.join('').trim()) {
          const dayStr = row[dayIdx] || '';
          const hour = row[hourIdx] || '';
          const className = row[classIdx] || '';
          const subject = row[subjectIdx] || '';
          const teacher = row[teacherIdx] || '';
          const room = row[roomIdx] || '';
          
          if (className && subject && dayStr && hour) {
            classes.add(className);
            if (teacher) teachers.add(teacher);
            
            const parsedDay = parseDayString(dayStr);
            
            schedule.push({
              class: className,
              teacher: teacher,
              subject: subject,
              room: room,
              day: parsedDay.day,
              session: parsedDay.session,
              period: parsePeriodNumber(hour)
            });
          }
        }
      });
      
      return schedule;
    }
    
    function parseDayString(dayStr) {
      const str = dayStr.toUpperCase().trim();
      let session = 'morning';
      let day = 0;
      
      if (str.startsWith('C')) {
        session = 'afternoon';
      }
      
      if (str.includes('2')) day = 1;
      else if (str.includes('3')) day = 2;
      else if (str.includes('4')) day = 3;
      else if (str.includes('5')) day = 4;
      else if (str.includes('6')) day = 5;
      
      return { day, session };
    }
    
    function parsePeriodNumber(periodStr) {
      const match = periodStr.match(/\d+/);
      return match ? parseInt(match[0]) : 0;
    }
    
    // Fetch data
    async function fetchData() {
      showLoading();
      
      try {
        const response = await fetch(DATA_URL);
        if (!response.ok) throw new Error('Không thể tải dữ liệu từ Google Sheets');
        
        const csv = await response.text();
        allData = parseCSV(csv);
        scheduleData = transformData(allData);
        
        if (scheduleData.length === 0) {
          throw new Error('Không tìm thấy dữ liệu hợp lệ trong bảng');
        }
        
        localStorage.setItem('tkb-cache', JSON.stringify({ data: allData, timestamp: Date.now() }));
        
        updateFilterOptions();
        renderSchedule();
        showToast('Đã tải dữ liệu thành công');
        showContent();
        
      } catch (error) {
        const cached = localStorage.getItem('tkb-cache');
        if (cached) {
          const { data } = JSON.parse(cached);
          allData = data;
          scheduleData = transformData(allData);
          updateFilterOptions();
          renderSchedule();
          showToast('Đang dùng dữ liệu offline');
          showContent();
        } else {
          showError(error.message);
        }
      }
    }
    
    function updateFilterOptions() {
      const select = document.getElementById('filter-select');
      select.innerHTML = '<option value="">-- Chọn --option>';
      
      if (currentView === 'class') {
        Array.from(classes).sort().forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });
      } else if (currentView === 'teacher') {
        Array.from(teachers).sort().forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          select.appendChild(opt);
        });
      }
    }
    
    function changeViewType() {
      currentView = document.getElementById('view-type').value;
      currentFilter = '';
      document.getElementById('filter-select').value = '';
      updateFilterOptions();
      renderSchedule();
    }
    
    function applyFilter() {
      currentFilter = document.getElementById('filter-select').value;
      renderSchedule();
    }
    
    function renderSchedule() {
      const container = document.getElementById('schedule-container');
      
      if (currentView === 'all') {
        container.innerHTML = renderAllSchedule();
      } else if (currentView === 'class' && currentFilter) {
        container.innerHTML = renderSingleSchedule(currentFilter, 'class');
      } else if (currentView === 'teacher' && currentFilter) {
        container.innerHTML = renderSingleSchedule(currentFilter, 'teacher');
      } else {
        container.innerHTML = '<div class="text-center text-secondary py-12 text-sm">Vui lòng chọn lớp hoặc giáo viêndiv>';
      }
    }
    
    function renderAllSchedule() {
      const sortedClasses = Array.from(classes).sort();
      let html = '';
      
      sortedClasses.forEach((className, idx) => {
        html += `<div class="print-page mb-8">`;
        html += renderSingleSchedule(className, 'class');
        html += `div>`;
      });
      
      return html;
    }
    
    function renderSingleSchedule(name, type) {
      const filtered = scheduleData.filter(item => 
        type === 'class' ? item.class === name : item.teacher === name
      );
      
      const morningPeriods = PERIODS_MORNING.filter(period => {
        return filtered.some(l => l.session === 'morning' && l.period === period.value);
      });
      
      const afternoonPeriods = PERIODS_AFTERNOON.filter(period => {
        return filtered.some(l => l.session === 'afternoon' && l.period === period.value);
      });
      
      let html = `
        <div class="card-bg rounded-lg overflow-hidden mb-6">
          <div class="p-4 border-b border-custom">
            <h2 class="text-base font-semibold text-primary">${type === 'class' ? 'Lớp' : 'Giáo viên'}: ${name}h2>
          div>
          <div class="p-4">
            <div class="schedule-grid">
              ${DAYS.map(day => `<div class="schedule-header">${day}div>`).join('')}
      `;
      
      if (morningPeriods.length > 0) {
        html += `<div class="session-header">Buổi Sángdiv>`;
        
        morningPeriods.forEach((period) => {
          html += `<div class="schedule-time">${period.label}div>`;
          
          for (let day = 1; day <= 5; day++) {
            const lesson = filtered.find(l => l.day === day && l.session === 'morning' && l.period === period.value);
            
            if (lesson) {
              html += `
                <div class="schedule-cell">
                  <div class="lesson-card">
                    <div class="lesson-subject">${lesson.subject}div>
                    ${type === 'class' ? 
                      `<div class="lesson-info">${lesson.teacher}div>` :
                      `<div class="lesson-info">${lesson.class}div>`
                    }
                    ${lesson.room ? `<div class="lesson-info">Phòng: ${lesson.room}div>` : ''}
                  div>
                div>
              `;
            } else {
              html += `<div class="schedule-cell">div>`;
            }
          }
        });
      }
      
      if (afternoonPeriods.length > 0) {
        html += `<div class="session-header">Buổi Chiềudiv>`;
        
        afternoonPeriods.forEach((period) => {
          html += `<div class="schedule-time">${period.label}div>`;
          
          for (let day = 1; day <= 5; day++) {
            const lesson = filtered.find(l => l.day === day && l.session === 'afternoon' && l.period === period.value);
            
            if (lesson) {
              html += `
                <div class="schedule-cell">
                  <div class="lesson-card">
                    <div class="lesson-subject">${lesson.subject}div>
                    ${type === 'class' ? 
                      `<div class="lesson-info">${lesson.teacher}div>` :
                      `<div class="lesson-info">${lesson.class}div>`
                    }
                    ${lesson.room ? `<div class="lesson-info">Phòng: ${lesson.room}div>` : ''}
                  div>
                div>
              `;
            } else {
              html += `<div class="schedule-cell">div>`;
            }
          }
        });
      }
      
      html += `div>div>div>`;
      return html;
    }
    
    function printSchedule() {
      window.print();
    }
    
    function refreshData() {
      fetchData();
    }
    
    function toggleDarkMode() {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-theme') === 'dark';
      
      html.setAttribute('data-theme', isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      
      document.getElementById('icon-light').classList.toggle('hidden', !isDark);
      document.getElementById('icon-dark').classList.toggle('hidden', isDark);
    }
    
    function showCodeDialog() {
      document.getElementById('code-dialog').classList.remove('hidden');
    }
    
    function hideCodeDialog(event) {
      if (!event || event.target.id === 'code-dialog') {
        document.getElementById('code-dialog').classList.add('hidden');
      }
    }
    
    function copyCode() {
      const codeContent = document.getElementById('code-content').textContent;
      navigator.clipboard.writeText(codeContent).then(() => {
        const btn = document.querySelector('.copy-btn');
        const text = document.getElementById('copy-text');
        btn.classList.add('copied');
        text.textContent = 'Đã copy!';
        
        setTimeout(() => {
          btn.classList.remove('copied');
          text.textContent = 'Copy';
        }, 2000);
      });
    }
    
    function showLoading() {
      document.getElementById('loading-state').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('error-state').classList.add('hidden');
    }
    
    function showContent() {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('error-state').classList.add('hidden');
    }
    
    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('error-state').classList.remove('hidden');
    }
    
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Element SDK
    async function onConfigChange(newConfig) {
      config = { ...defaultConfig, ...newConfig };
      
      const schoolName = document.getElementById('school-name');
      const schoolYear = document.getElementById('school-year');
      
      if (schoolName) schoolName.textContent = config.school_name || defaultConfig.school_name;
      if (schoolYear) schoolYear.textContent = config.school_year || defaultConfig.school_year;
    }
    
    function mapToCapabilities(cfg) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }
    
    function mapToEditPanelValues(cfg) {
      return new Map([
        ['school_name', cfg.school_name || defaultConfig.school_name],
        ['school_year', cfg.school_year || defaultConfig.school_year]
      ]);
    }
    
    // Initialize
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
    
    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('icon-light').classList.toggle('hidden', savedTheme !== 'dark');
    document.getElementById('icon-dark').classList.toggle('hidden', savedTheme === 'dark');
    
    // Start app
    fetchData();
  script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bef042d87a908e5',t:'MTc2ODU4MTIyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();script>body>
html>
